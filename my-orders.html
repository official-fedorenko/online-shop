<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–æ–∏ –∑–∞–∫–∞–∑—ã - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ú–∞–≥–∞–∑–∏–Ω</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      .orders-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .orders-container {
        margin-top: 20px;
      }

      .order-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #007bff;
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .order-number {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .order-status {
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
      }

      .status-processing {
        background: #fff3cd;
        color: #856404;
      }

      .status-confirmed {
        background: #cce5ff;
        color: #004085;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .order-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .info-item {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .info-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .info-value {
        font-weight: 500;
        color: #333;
      }

      .order-items {
        border-top: 1px solid #eee;
        padding-top: 15px;
      }

      .order-items h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 16px;
      }

      .items-summary {
        color: #666;
        line-height: 1.5;
      }

      .order-total {
        text-align: right;
        font-size: 18px;
        font-weight: 600;
        color: #007bff;
        margin-top: 10px;
      }

      .view-details-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
      }

      .view-details-btn:hover {
        background: #0056b3;
      }

      .order-details {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .order-details.show {
        display: block;
      }

      .details-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
      }

      .details-item:last-child {
        border-bottom: none;
      }

      .item-info {
        flex: 1;
      }

      .item-name {
        font-weight: 500;
        margin-bottom: 2px;
      }

      .item-meta {
        font-size: 12px;
        color: #666;
      }

      .item-price {
        font-weight: 600;
        color: #333;
      }

      .empty-orders {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-orders h3 {
        margin-bottom: 10px;
        color: #333;
      }

      .continue-shopping {
        display: inline-block;
        margin-top: 20px;
        padding: 10px 20px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 5px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .order-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .order-info {
          grid-template-columns: 1fr;
        }

        .details-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="nav-container">
          <a href="/" class="nav-logo">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ú–∞–≥–∞–∑–∏–Ω</a>
          <ul class="nav-menu">
            <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="/cart">–ö–æ—Ä–∑–∏–Ω–∞</a></li>
            <li><a href="/my-orders" class="active">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</a></li>
            <li class="auth-links">
              <a href="/auth" id="authLink">–í–æ–π—Ç–∏</a>
              <span id="userInfo" style="display: none">
                <span id="userName"></span>
                <a href="#" onclick="logout()">–í—ã–π—Ç–∏</a>
              </span>
            </li>
          </ul>
          <div class="cart-icon">
            <a href="/cart"> üõí <span class="cart-count">0</span> </a>
          </div>
        </div>
      </nav>
    </header>

    <main class="orders-page">
      <h1>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>

      <div class="orders-container" id="ordersContainer">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <p>&copy; 2024 –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ú–∞–≥–∞–∑–∏–Ω. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
      </div>
    </footer>

    <script src="/js/cart.js"></script>
    <script src="/js/user-auth.js"></script>
    <script>
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤
      document.addEventListener("DOMContentLoaded", function () {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        if (!cart.isUserLoggedIn()) {
          alert("–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É");
          window.location.href = "/auth";
          return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
        loadOrders();

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        updateNavigationAuth();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
        cart.updateCartDisplay();
      });

      async function loadOrders() {
        const container = document.getElementById("ordersContainer");

        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/orders/my", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤");
          }

          const orders = await response.json();
          renderOrders(orders);
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:", error);
          container.innerHTML = `
                    <div class="error-message">
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ${error.message}
                    </div>
                `;
        }
      }

      function renderOrders(orders) {
        const container = document.getElementById("ordersContainer");

        if (orders.length === 0) {
          container.innerHTML = `
                    <div class="empty-orders">
                        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h3>
                        <p>–û—Ñ–æ—Ä–º–∏—Ç–µ –≤–∞—à –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –≤ –Ω–∞—à–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ</p>
                        <a href="/" class="continue-shopping">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º</a>
                    </div>
                `;
          return;
        }

        container.innerHTML = orders
          .map(
            (order) => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-number">–ó–∞–∫–∞–∑ #${order.id}</div>
                        <div class="order-status status-${order.status}">
                            ${getStatusText(order.status)}
                        </div>
                    </div>
                    
                    <div class="order-info">
                        <div class="info-item">
                            <div class="info-label">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</div>
                            <div class="info-value">${formatDate(
                              order.created_at
                            )}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</div>
                            <div class="info-value">${getDeliveryText(
                              order.delivery_type
                            )}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
                            <div class="info-value">${getPaymentText(
                              order.payment_method
                            )}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞</div>
                            <div class="info-value">‚Ç¨${order.total_amount.toFixed(
                              2
                            )}</div>
                        </div>
                    </div>
                    
                    <div class="order-items">
                        <h4>–¢–æ–≤–∞—Ä—ã:</h4>
                        <div class="items-summary">${
                          order.items_summary || "–ó–∞–≥—Ä—É–∑–∫–∞..."
                        }</div>
                        <div class="order-total">
                            –ò—Ç–æ–≥–æ: ‚Ç¨${order.total_amount.toFixed(2)}
                        </div>
                        <button class="view-details-btn" onclick="toggleOrderDetails(${
                          order.id
                        })">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        <div class="order-details" id="details-${order.id}">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞...</div>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      async function toggleOrderDetails(orderId) {
        const detailsContainer = document.getElementById(`details-${orderId}`);

        if (detailsContainer.classList.contains("show")) {
          detailsContainer.classList.remove("show");
          return;
        }

        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`/api/orders/${orderId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞");
          }

          const orderDetails = await response.json();
          renderOrderDetails(detailsContainer, orderDetails);
          detailsContainer.classList.add("show");
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:", error);
          detailsContainer.innerHTML = `
                    <div class="error-message">
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ${error.message}
                    </div>
                `;
          detailsContainer.classList.add("show");
        }
      }

      function renderOrderDetails(container, order) {
        const deliveryCost = getDeliveryCost(order.delivery_type);
        const subtotal = order.total_amount - deliveryCost;

        container.innerHTML = `
                <div class="details-section">
                    <strong>–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ:</strong>
                    ${order.items
                      .map(
                        (item) => `
                        <div class="details-item">
                            <div class="item-info">
                                <div class="item-name">${
                                  item.product_name
                                }</div>
                                <div class="item-meta">${
                                  item.quantity
                                } √ó ‚Ç¨${item.product_price.toFixed(2)}</div>
                            </div>
                            <div class="item-price">‚Ç¨${item.total_price.toFixed(
                              2
                            )}</div>
                        </div>
                    `
                      )
                      .join("")}
                    
                    <div class="details-item">
                        <div class="item-info">
                            <div class="item-name">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤:</div>
                        </div>
                        <div class="item-price">‚Ç¨${subtotal.toFixed(2)}</div>
                    </div>
                    
                    ${
                      deliveryCost > 0
                        ? `
                        <div class="details-item">
                            <div class="item-info">
                                <div class="item-name">–î–æ—Å—Ç–∞–≤–∫–∞:</div>
                            </div>
                            <div class="item-price">‚Ç¨${deliveryCost.toFixed(
                              2
                            )}</div>
                        </div>
                    `
                        : ""
                    }
                    
                    <div class="details-item" style="border-top: 2px solid #007bff; font-weight: 600;">
                        <div class="item-info">
                            <div class="item-name">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</div>
                        </div>
                        <div class="item-price">‚Ç¨${order.total_amount.toFixed(
                          2
                        )}</div>
                    </div>
                </div>
                
                <div class="details-section" style="margin-top: 15px;">
                    <strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
                    <div class="details-item">
                        <div class="item-info">–ò–º—è: ${order.customer_name}</div>
                    </div>
                    <div class="details-item">
                        <div class="item-info">Email: ${
                          order.customer_email
                        }</div>
                    </div>
                    <div class="details-item">
                        <div class="item-info">–¢–µ–ª–µ—Ñ–æ–Ω: ${
                          order.customer_phone
                        }</div>
                    </div>
                    ${
                      order.delivery_address
                        ? `
                        <div class="details-item">
                            <div class="item-info">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: ${order.delivery_address}</div>
                        </div>
                    `
                        : ""
                    }
                    ${
                      order.notes
                        ? `
                        <div class="details-item">
                            <div class="item-info">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${order.notes}</div>
                        </div>
                    `
                        : ""
                    }
                </div>
            `;
      }

      function getStatusText(status) {
        const statusMap = {
          processing: "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ",
          confirmed: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω",
          completed: "–ó–∞–≤–µ—Ä—à–µ–Ω",
          cancelled: "–û—Ç–º–µ–Ω–µ–Ω",
        };
        return statusMap[status] || status;
      }

      function getDeliveryText(deliveryType) {
        const deliveryMap = {
          pickup: "–°–∞–º–æ–≤—ã–≤–æ–∑",
          courier: "–ö—É—Ä—å–µ—Ä—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞",
          delivery: "–ü–æ—á—Ç–æ–≤–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞",
        };
        return deliveryMap[deliveryType] || deliveryType;
      }

      function getPaymentText(paymentMethod) {
        const paymentMap = {
          cash: "–ù–∞–ª–∏—á–Ω—ã–µ",
          iban: "–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥",
        };
        return paymentMap[paymentMethod] || paymentMethod;
      }

      function getDeliveryCost(deliveryType) {
        switch (deliveryType) {
          case "courier":
            return 5;
          case "delivery":
            return 3;
          default:
            return 0;
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("ru-RU", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("userRole");
        localStorage.removeItem("userName");
        localStorage.removeItem("cart");
        window.location.href = "/";
      }
    </script>
  </body>
</html>
